---
title: "Round by Round Seed Distribution in NCAA Tournament"
author: "John Kane"
date: '2019-04-02'
slug: round-by-round-seed-distribution-in-ncaa-tournament
tags:
- basketball
- March Madness
- R
categories:
- basketball
- March Madness
- R
---

Working backwards through the NCAA tournament

Most years filling out my bracket I work "forwards"

The traditional office pool works differently than the Kaggle competition for March Madness. In the office pool you typically choose the winner of each game and accumulate an increasing number of points for each correct pick. In the Kaggle competition you compete by determining a probabilistic evaluation of every possible matchup, and are then judged on how well calibrated the outcome was to your forecast. 

You are not credited for predicting a correct Elite Eight matchup, but by whether or not the matchup that occurs you have a good forecast for.


## Data

The data comes from the Kaggle competition for March Madness[^1]. I didn't submit an entry to the contest but used the data for this analysis.

```{r}
library(tidyverse)
library(knitr)
seeds <- read_csv("/home/john/basketball/march_madness/2019/data/DataFiles/NCAATourneySeeds.csv")
results <- read_csv("/home/john/basketball/march_madness/2019/data/DataFiles/NCAATourneyCompactResults.csv")
```


Join the results data with the seed data. 

```{r}
results_w_seeds <- 
  inner_join(results %>% select(Season,WTeamID,LTeamID),
             seeds %>% mutate(WSeed = str_sub(Seed,2,3)),
             by = c('Season','WTeamID' = 'TeamID')) %>%
  inner_join(.,
             seeds %>% mutate(LSeed = str_sub(Seed,2,3)),
             by = c('Season','LTeamID' = 'TeamID')) %>%
  mutate(matchup = paste0(pmin(WSeed,LSeed),"-",pmax(WSeed,LSeed))) %>%
  select(Season,WSeed,LSeed,matchup)

head(results_w_seeds)
```



#### Determining which round each game was

The Kaggle data was missing one important piece of information -- which round of the tournment each game was. To solve for this I had to rely on my knowledge of the NCAA tournament. I knew that at some point they started add the "play-in" games on the Tuesday before the first round. Eventually addiontal play-in games were added first on the same Tuesday, then on the Wednesday before the first round. 

Additionally, each round except for Final Four, Championship, and early play-in games take place over two days. 

So the first four rounds occur on a total of 8 days, then the fifth and sixth rounds occur on one day each, so there are 10 total days worth of games, excluding the play-in games. 

The Kaggle data does provide the day of the season for each game. If I first limit the results to only tournament games, then count how many days since the first tournament game of a give year occurred. 


```{r}
season_first_tourney_day <-
results %>%
  group_by(Season) %>%
  summarise(first_day = min(DayNum))

results_tourney_day <-
  results %>%
  inner_join(season_first_tourney_day, by = 'Season') %>%
  mutate(days_since_first = DayNum - first_day)
```


```{r}
table(results_tourney_day$days_since_first)
```


```{r}
results_tourney_day %>%
  group_by(Season) %>%
  summarise(count = n_distinct(days_since_first))
```


With this data in hand I can assign rounds to each game based on Season and days since day of the tournament that year. I assign any play-in games to be round "0."


```{r}
results_tourney_day <-
  results_tourney_day%>%
  mutate(round  = case_when(
    Season %in% c(1985:2000) & days_since_first %in% c(0,1)  ~ 1,
    Season %in% c(1985:2000) & days_since_first %in% c(2,3)  ~ 2,
    Season %in% c(1985:2000) & days_since_first %in% c(7,8)  ~ 3,
    Season %in% c(1985:2000) & days_since_first %in% c(9,10) ~ 4,
    Season %in% c(1985:2000) & days_since_first %in% c(16)   ~ 5,
    Season %in% c(1985:2000) & days_since_first %in% c(18)   ~ 6,
    Season %in% c(2001:2010) & days_since_first %in% c(0)    ~ 0,
    Season %in% c(2001:2010) & days_since_first %in% c(2,3)  ~ 1,
    Season %in% c(2001:2010) & days_since_first %in% c(4,5)  ~ 2,
    Season %in% c(2001:2010) & days_since_first %in% c(9,10) ~ 3,
    Season %in% c(2001:2010) & days_since_first %in% c(11,12)~ 4,
    Season %in% c(2001:2010) & days_since_first %in% c(18)   ~ 5,
    Season %in% c(2001:2010) & days_since_first %in% c(20)   ~ 6,
    Season %in% c(2011:2018) & days_since_first %in% c(0,1)  ~ 0,
    Season %in% c(2011:2018) & days_since_first %in% c(2,3)  ~ 1,
    Season %in% c(2011:2018) & days_since_first %in% c(4,5)  ~ 2,
    Season %in% c(2011:2018) & days_since_first %in% c(9,10) ~ 3,
    Season %in% c(2011:2018) & days_since_first %in% c(11,12)~ 4,
    Season %in% c(2011:2018) & days_since_first %in% c(18)   ~ 5,
    Season %in% c(2011:2018) & days_since_first %in% c(20)   ~ 6,
    TRUE ~ NA_real_))

```


```{r}
results_w_seeds <-
  results_tourney_day %>% select(Season,WTeamID,LTeamID,round) %>%
  inner_join(.,
             seeds %>% mutate(WSeed = str_sub(Seed,2,3)),
             by = c('Season','WTeamID' = 'TeamID')) %>%
  inner_join(.,
             seeds %>% mutate(LSeed = str_sub(Seed,2,3)),
             by = c('Season','LTeamID' = 'TeamID')) %>%
  select(Season,WSeed,LSeed,round)
```


## Seed Distributions by Round

To represent the different seed distributions I'll concatenate the count of each seed in that round togehter.

So if the Sweet Sixteen has:

* 4 #1 seeds
* 3 #2 seeds
* 3 #3 seeds
* 1 #4 seed
* 2 #5 seeds
* 2 #6 seeds
* 1 #7 seeds
* 0 8, 9, 10, 11, 12, 13, 14, 15, 16 seeds

In the data I'll represent that as `4331221000000000`. 

In order to create this full picture we'll need an "anchor" data frame for joining.
```{r}
anchor <- tibble(`01` = 0,`02` = 0, `03` = 0, `04` = 0, `05` = 0, `06` = 0, `07` = 0, `08` = 0, `09` = 0, `10` = 0, `11` = 0, `12` =0, `13` = 0, `14` = 0, `15` = 0, `16` = 0)
```


#### Champion

```{r}
results_w_seeds %>%
  filter(round == 6) %>%
  group_by(Season,WSeed) %>%
  summarise(count = n()) %>%
  spread(key = WSeed, value = count, fill = 0) %>%
  full_join(.,
            tibble(`01` = 0,`02` = 0, `03` = 0, `04` = 0, `05` = 0, `06` = 0, `07` = 0, `08` = 0, `09` = 0, `10` = 0, 
                   `11` = 0, `12` =0, `13` = 0, `14` = 0, `15` = 0, `16` = 0))
  replace(.,is.na(.),0) %>%
  mutate(champion = paste0(`01`,`02`,`03`,`04`,`05`,`06`,`07`,`08`,`09`,`10`,`11`,`12`,`13`,`14`,`15`,`16`)) %>%
  group_by(champion) %>%
  summarise(count = n()) %>%
  mutate(pct = count/sum(count)) %>%
  arrange(desc(count))
```

#### Championship Game

```{r}
results_w_seeds %>%
  filter(round == 5) %>%
  group_by(Season,WSeed) %>%
  summarise(count = n()) %>%
  spread(key = WSeed, value = count, fill = 0) %>%
  full_join(.,tibble(`01` = 0,`02` = 0, `03` = 0, `04` = 0, `05` = 0, `06` = 0, `07` = 0, `08` = 0, `09` = 0, `10` = 0, `11` = 0, `12` =0, `13` = 0, `14` = 0, `15` = 0, `16` = 0), by = NULL) %>%
    replace(.,is.na(.),0) %>%
  mutate(championshipgame = paste0(`01`,`02`,`03`,`04`,`05`,`06`,`07`,`08`,`09`,`10`,`11`,`12`,`13`,`14`,`15`,`16`)) %>%
  group_by(championshipgame) %>%
  summarise(count = n()) %>%
  mutate(pct = count/sum(count)) %>%
  arrange(desc(count))
```

The most likely matchup is between a #1 and a #2 seed, followed by two #1 seeds.

#### Final Four

```{r}
results_w_seeds %>%
  filter(round == 4) %>%
  group_by(Season,WSeed) %>%
  summarise(count = n()) %>%
  spread(key = WSeed, value = count, fill = 0) %>%
  full_join(.,tibble(`01` = 0,`02` = 0, `03` = 0, `04` = 0, `05` = 0, `06` = 0, `07` = 0, `08` = 0, `09` = 0, `10` = 0, `11` = 0, `12` =0, `13` = 0, `14` = 0, `15` = 0, `16` = 0), by = NULL) %>%
    replace(.,is.na(.),0) %>%
  mutate(finalfour = paste0(`01`,`02`,`03`,`04`,`05`,`06`,`07`,`08`,`09`,`10`,`11`,`12`,`13`,`14`,`15`,`16`)) %>%
  group_by(finalfour) %>%
  summarise(count = n()) %>%
  mutate(pct = count/sum(count)) %>%
  arrange(desc(count))
```

There are 34 years worth of data and 25 distinct distributions of final four teams. I think at this point it becomes difficult to lean one way or another, as the most common Final Four happens less than 10% of the time.

## Distinct Seed Distributions by Round

```{r}
results_w_seeds %>%
  filter(round > 0) %>%
  group_by(Season,round,WSeed) %>%
  summarise(count = n()) %>%
  spread(key = WSeed, value = count, fill = 0) %>%
  mutate(seed_dist = paste0(`01`,`02`,`03`,`04`,`05`,`06`,`07`,`08`,`09`,`10`,`11`,`12`,`13`,`14`,`15`,`16`)) %>%
  select(Season,round,seed_dist) %>%
  ungroup() %>%
  group_by(round) %>%
  summarise(years = n(),
            distinct_dist = n_distinct(seed_dist))
```

I knew that there are seemingly infinite[^2] number of possible brackets, but I also thought that by collapsing the data into respective seeds that it would reduce some of that complexity. 

Summarizing the above table, from 1985-2018 there has never been a repeat seed distribution in either the first or second round of the tournament! That was really surprising to me. 

The Sweet Sixteen and Elite Eight also have 9 and 3, respectively, non-duplicate values. 


## Average Seed Distribution by Round

Since it isn't helpful to look at the actual distributions and their frequencies by round, we can summarize those distributions by taking the average. 

```{r}
results_w_seeds %>%
  filter(round > 0) %>%
  group_by(Season,round,WSeed) %>%
  summarise(count = n()) %>%
  spread(key = WSeed, value = count, fill = 0) %>%
  ungroup() %>%
  select(-Season) %>%
  group_by(round) %>%
  summarise_if(is_numeric,mean,na.rm = TRUE) %>%
  t() %>%
  round(1) %>%
  `colnames<-`(c("Round of 32","Sweet 16","Elite 8","Final Four","Championship Game","Champion")) %>%
  kable()
```

Down the left hand size of this table is the seed #'s, and the columns across the top correpsond to the round of the
tournament. The table values are the average number of each seed to reach each round of the tournament. So there are on average 4 #1 Seeds in the Round of 32, 3.4 in the Sweet 16, 2.8 in the Elite Eight, 1.6 in the Final Four, 1.0 in the Championship, and is the winner 60% of the time. 

## 2019 Results

How did the 2019 tournament play out with respect to these averages? Read on below...

#### Round of 32

| Seed   | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|
| Average|4.0|3.8|3.4|3.2|2.6|2.5|2.5|2.0|2.0|1.5 |1.5 | 1.4|0.8 |0.6 |0.2 | 0.0|
| 2019   | 4 | 4 | 4 | 3 | 1 | 3 | 1 | 0 | 4 | 3  |  1 |  3 |  1 |  0 |  0 | 0  |

#### Sweet 16

| Seed   | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|
| Average|3.4|2.5|2.1|1.9|1.4|1.2|0.8|0.4|0.2|0.7 |0.6 | 0.6|0.2 | 0.1| 0.0|0.0 |
| 2019   | 4 | 4 | 4 | 2 | 1 | 0 | 0 | 0 | 0 | 0  | 0  | 0  |  0 |  0 |  0 |  0 |

#### Elite 8

| Seed   | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|
| Average|2.8|1.8|1.0|0.6|0.2|0.4|0.3|0.2|0.1|0.2 |0.2 | 0.6|0.0 | 0.0| 0.0|0.0 |
| 2019   | 3 | 2 | 2 | 0 | 1 | 0 | 0 | 0 | 0 | 0  |  0 |  0 |  0 |  0 |  0 |  0 |

#### Final Four

| Seed   | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|
| Average|1.6|0.8|0.5|0.4|0.2|0.1|0.1|0.1|0.0|0.0 |0.1 |0.0 |0.0 |0.0 |0.0 |0.0 |
| 2019   | 1 | 1 | 1 | 0 | 1 | 0 | 0 | 0 | 0 | 0  |  0 |  0 |  0 |  0 |  0 |  0 |

#### Championship Game

| Seed   | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|
| Average|1.0|0.4|0.3|0.1|0.1|0.1|0.0|0.1|0.0|0.0 |0.0 |0.0 | 0.0|0.0 |0.0 |0.0 |
| 2019   | 1 | 0 | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0  |  0 |  0 |  0 |  0 |  0 |  0 |

#### Champion

| Seed   | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|
| Average|0.6|0.1|0.1|0.0|0.0|0.0|0.0|0.0|0.0|0.0 |0.0 |0.0 |0.0 |0.0 |0.0 |0.0 | 
| 2019   | 1 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0  |  0 |  0 |  0 |  0 |  0 |  0 | 

## Closing Thoughts

The first two rounds of the tournament were chalky[^3], which lends itself nicely to using long run averages, as over that timeframe the higher seeds are generally better teams and happen to win. 


I thought that 

The more difficult piece to this is the logical extension of knowing how many of each seed are likely to advance to the next
round. For example, I know there are on average going to be 2 1 seeds in the Final Four, which 2 1 seeds do I pick?

My approach this year was to use the pre tournament probabilities from 538[^4]. So I selected the 1 seed with the highest pre-tournament probability of winning the championship (Duke, ~28%)


Next year: expand to looking at conditional distributions. So Conditional on a 1 seed winning the tournament, what is the average distribution. Then conditional on the chosen championship game, what is the average final four. And so on...


[^1]:https://www.kaggle.com/c/mens-machine-learning-competition-2019
[^2]:https://www.ncaa.com/news/basketball-men/bracketiq/2019-03-20/perfect-ncaa-bracket-absurd-odds-march-madness-dream
[^3]:https://projects.fivethirtyeight.com/2019-march-madness-predictions/
[^4]:https://www.cbssports.com/college-basketball/news/march-madness-2019-chalk-has-ruled-the-ncaa-tournament-so-far-but-that-sets-up-what-could-be-a-great-sweet-16/